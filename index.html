<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Virtual Mixer Trainer v0.2</title>

  <!-- BRAND ICONS -->
  <link rel="icon" href="./favicon.ico">
  <link rel="icon" type="image/svg+xml" href="./favicon.svg">
  <link rel="apple-touch-icon" href="./apple-touch-icon.png" sizes="180x180">

  <style>
    :root{
      --bg:#0e1116;--panel:#151a22;--panel2:#1b222c;--text:#e8eef9;--muted:#9fb0c6;--accent:#4da3ff;--good:#7ce38b;--warn:#ffca63;--danger:#ff7a7a;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    body{margin:0;background:linear-gradient(180deg,#0d1117,#0b0e13 50%,#0c1016);color:var(--text)}

    /* Header (same layout) */
    header{position:sticky;top:0;background:rgba(13,17,23,.85);backdrop-filter: blur(6px);border-bottom:1px solid #1f2630;z-index:5}
    header .wrap{display:flex;align-items:center;gap:12px;padding:10px 12px;flex-wrap:wrap}
    h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.3px}
    .brandmark{width:20px;height:20px;border-radius:6px;border:1px solid #263040;background:#0f141b;object-fit:contain}

    .pill{border:1px solid #2b3442;padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px;white-space:nowrap}
    .hidden{display:none}

    /* Buttons */
    .btn{background:#121823;color:#cfe1fb;border:1px solid #283343;padding:6px 10px;border-radius:10px;font-size:12px;cursor:pointer}
    .btn:hover{border-color:#3a4c66}
    .toggle{display:flex;gap:8px}
    .toggle button{flex:1}
    /* Record button state */
    .btn-rec{ border-color:#3a2830; }
    .btn-rec.recording{ background:#2a0f12;border-color:#7a2b2b;color:#ffb9b9; }
    .pill.recording{ border-color:#7a2b2b;color:#ffb9b9;background:#210d10; }

    /* Channel grid (like your first script) */
    .grid{display:grid;grid-template-columns:repeat(7,minmax(220px,1fr));gap:14px;padding:16px}
    .strip{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid #1f2630;border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:10px}
    .strip h3{margin:0 0 4px;font-size:13px;color:#d7e3f8;letter-spacing:.3px}
    .section{background:#0f141b;border:1px solid #212938;border-radius:12px;padding:10px}
    .row{display:flex;align-items:center;gap:8px;margin:6px 0}
    label{font-size:12px;color:#b7c6db}
    input[type="range"]{width:100%}
    input[type="text"]{background:#0c1117;color:var(--text);border:1px solid #233042;border-radius:8px;padding:6px;width:180px}

    /* METERS: bigger + clearer */
    .meter{background:#0b0f15;border:1px solid #243145;border-radius:8px;position:relative;overflow:hidden}
    .meter .bar{position:absolute;bottom:0;left:0;right:0;height:0;background:linear-gradient(180deg,#6be47a 0%,#ffe27a 65%,#ff8b8b 100%);transition:height 60ms linear}
    /* Channel meters inside rows */
    .row .meter{flex:0 0 18px;width:18px;height:140px;border-radius:8px}
    /* Master meter larger */
    #masterMeter.meter{flex:0 0 22px;width:22px;height:160px;border-radius:10px}

    .small{font-size:11px;color:#93a7c0}

    /* Bottom: Master + Notes */
    .master{grid-column:1/-1;display:grid;grid-template-columns:380px 1fr;gap:14px;padding:0 16px 16px}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid #1f2630;border-radius:16px;padding:12px}
    .row.inline>*{flex:1}
    select{width:100%;background:#0c1117;color:var(--text);border:1px solid #233042;border-radius:10px;padding:8px}

    .note{font-size:12px;color:#a9bad5}
    .badge{display:inline-flex;align-items:center;gap:6px;background:#0f1620;border:1px solid #293447;color:#c6d5ef;border-radius:999px;padding:6px 10px;font-size:12px}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:#0d131b;border:1px solid #293447;border-bottom-color:#1c2734;padding:2px 6px;border-radius:6px;font-size:11px}
    .foot{display:flex;gap:8px;flex-wrap:wrap}

    .disabled{opacity:.45;pointer-events:none;filter:grayscale(.3)}

    @media (max-width: 1200px){
      .grid{grid-template-columns:repeat(3,minmax(220px,1fr));}
      .master{grid-template-columns:repeat(1,1fr);}
    }
    @media (max-width: 750px){
      .grid{grid-template-columns:repeat(1,minmax(220px,1fr));}
      .master{grid-template-columns:repeat(1,1fr);}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <!-- brand icon beside the title -->
      <img class="brandmark" src="./favicon.svg" alt="Logo">
      <h1>Virtual Mixer Trainer <span class="small">v0.2</span></h1>
      <span class="pill">Load stems ‚Ä¢ Practice live & studio ‚Ä¢ üé∑ Sax ‚Ä¢ Demo/Full lock</span>

      <button id="playAll" class="btn">‚ñ∂ Play All</button>
      <button id="pauseAll" class="btn">‚è∏ Pause All</button>
      <button id="recordBtn" class="btn btn-rec">‚è∫ Record</button>
      <span id="recTimer" class="pill hidden">00:00</span>

      <div style="margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <label class="small">Scenario</label>
        <select id="scenario">
          <option value="none">‚Äî None (manual) ‚Äî</option>
          <option value="worship_live">Worship Band (Live)</option>
          <option value="studio_pop">Pop Vocals (Studio)</option>
          <option value="jazz_sax">Jazz / Sax Solo</option>
        </select>
        <button id="applyScenario" class="btn">Apply</button>
        <span class="pill">License: <span id="licenseStatus">DEMO</span></span>
        <input id="licenseInput" type="text" placeholder="Enter license key">
        <button id="activateBtn" class="btn">Activate</button>
        <!-- added: deactivate button -->
        <button id="deactivateBtn" class="btn">Deactivate</button>
      </div>
    </div>
  </header>

  <section class="grid" id="grid"></section>

  <!-- Bottom: Master Bus + How to use / Notes -->
  <section class="master">
    <div class="card section">
      <h3>Master Bus</h3>
      <div class="row"><label>Master Fader</label><input id="masterFader" type="range" min="0" max="1.5" step="0.01" value="1"></div>
      <div class="row"><label>Reverb Return</label><input id="reverbReturn" type="range" min="0" max="1" step="0.01" value="0.2"></div>
      <div class="row"><label>Master Meter</label><div id="masterMeter" class="meter" aria-label="master meter"><div class="bar"></div></div></div>
      <div class="row foot">
        <span class="badge">Tip: Peaks ~ -6 dBFS. Avoid red.</span>
      </div>
    </div>

    <div class="card section" style="grid-column:span 1">
      <h3>How to use</h3>
      <div class="note">
        Demo mode: only the first 3 channels are active and scenarios are limited. Enter a valid key to unlock all features.
      </div>
      <h3 style="margin-top:10px">Training Notes</h3>
      <ul class="note" style="margin-left:18px">
        <li><b>Gain staging:</b> Set <span class="kbd">TRIM</span> first.</li>
        <li><b>HPF:</b> Vocals/Sax start 90‚Äì120 Hz.</li>
        <li><b>EQ:</b> Clean muddiness (200‚Äì400 Hz); presence (2‚Äì5 kHz); air (10‚Äì12 kHz).</li>
        <li><b>Pan:</b> Lead center; BGVs L/R; sax slightly off-center.</li>
        <li><b>Aux/Reverb:</b> Less in live to reduce feedback.</li>
        <li><b>Compressor:</b> Ratio 2‚Äì3:1, medium attack/release.</li>
        <li><b>Delay:</b> Slap (90‚Äì140 ms) for sax/vocals in studio.</li>
      </ul>
    </div>
  </section>

  <script>
(() => {
  // ====== BASIC DOM HOOKS (use your existing IDs) ======
  const input          = document.getElementById('licenseInput');
  const activateBtn    = document.getElementById('activateBtn');
  const deactivateBtn  = document.getElementById('deactivateBtn'); // make sure this button exists in your header
  const licenseStatus  = document.getElementById('licenseStatus');
  const playAllBtnOrig = document.getElementById('playAll');
  const pauseAllBtn    = document.getElementById('pauseAll');

  // If you don't already have a Deactivate button in HTML, add:
  // <button id="deactivateBtn" class="btn">Deactivate</button>

  // ====== GLOBAL AUDIO CONTEXT HOOKS (we reuse your existing ones if present) ======
  // These are only *read* here; your main audio code should already define them.
  const ctx           = window.ctx;
  const state         = window.state || { channels:{} };
  const reverbReturn  = window.reverbReturn;

  // ====== APP STATE ======
  // Respect an existing global isFull flag if you already define it; otherwise create it.
  if (typeof window.isFull === 'undefined') window.isFull = false;

  // A super-small "device id" persisted to tie activations to a browser/device
  function getDeviceId() {
    let id = localStorage.getItem('vmix_device_id');
    if (!id) {
      id = 'dev-' + Math.random().toString(36).slice(2) + Date.now().toString(36);
      localStorage.setItem('vmix_device_id', id);
    }
    return id;
  }

  // Persisted license
  function saveLicense(key, plan) {
    localStorage.setItem('vmix_license', JSON.stringify({ key, plan }));
  }
  function loadLicense() {
    try { return JSON.parse(localStorage.getItem('vmix_license') || 'null'); }
    catch { return null; }
  }
  function clearLicense() {
    localStorage.removeItem('vmix_license');
  }

  // ====== NETLIFY FUNCTION HELPERS (Server) ======
  async function verifyKey(key) {
    const url = `/.netlify/functions/verify?key=${encodeURIComponent(key)}`;
    const res = await fetch(url, { headers: { 'Cache-Control':'no-cache' }});
    return res.json();
  }
  async function activateKey(key, deviceId) {
    const res = await fetch('/.netlify/functions/activate', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ key, deviceId })
    });
    return res.json();
  }
  async function deactivateKey(key, deviceId) {
    const res = await fetch('/.netlify/functions/deactivate', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ key, deviceId })
    });
    return res.json();
  }

  // ====== DEMO LOCKS ======
  function isStripLocked(idx){ return !window.isFull && idx > 2; } // only first 3 strips active in demo

  // Make this robust and idempotent (safe to call many times)
  function refreshDemoLocks(){
    const strips = Array.from(document.querySelectorAll('.strip'));

    strips.forEach((el, idx) => {
      const locked = isStripLocked(idx);
      el.classList.toggle('disabled', locked);

      // Disable all interactive controls
      el.querySelectorAll('input, button, select').forEach(ctrl => {
        ctrl.disabled = locked;
      });

      // If a channel exists in your state, also mark + silence it
      const chId = Object.keys(state.channels)[idx];
      const ch   = state.channels[chId];
      if (ch){
        ch.locked = locked;
        if (locked){
          try { ch.media.pause(); } catch {}
          try { ch.nodes?.postFader && (ch.nodes.postFader.gain.value = 0); } catch {}
        }
      }
    });

    // (Optional) limit reverb in demo
    const rrEl = document.getElementById('reverbReturn');
    if (!window.isFull && rrEl && reverbReturn){
      const cap = 0.20;
      if (parseFloat(rrEl.value) > cap){
        rrEl.value = cap;
        try { reverbReturn.gain.value = cap; } catch {}
      }
    }
  }

  // ====== FULL / DEMO MODE APPLY ======
  function applyFullMode(enabled){
    window.isFull = !!enabled;
    if (licenseStatus) licenseStatus.textContent = enabled ? 'FULL' : 'DEMO';
    // If your old code also uses this name, we keep it identical:
    refreshDemoLocks();
  }

  // Expose for any of your other code that may call it
  window.refreshDemoLocks = refreshDemoLocks;
  window.applyFullMode    = applyFullMode;

  // ====== ENSURE PLAY ONLY UNLOCKED STRIPS ======
  // Safely replace Play All button to remove any previous listeners
  if (playAllBtnOrig) {
    const playAllBtn = playAllBtnOrig.cloneNode(true);
    playAllBtnOrig.parentNode.replaceChild(playAllBtn, playAllBtnOrig);
    playAllBtn.addEventListener('click', ()=>{
      if (ctx && ctx.state === 'suspended') { try { ctx.resume(); } catch {} }
      for (const ch of Object.values(state.channels)){
        if (!ch?.locked && ch?.media?.src){
          try { ch.media.play().catch(()=>{}); } catch {}
        }
      }
    });
  }

  // Pause All is usually fine as-is; if you want to ensure it pauses everything:
  if (pauseAllBtn && !pauseAllBtn._vmixBound){
    pauseAllBtn._vmixBound = true;
    pauseAllBtn.addEventListener('click', ()=>{
      for (const ch of Object.values(state.channels)){
        try { ch.media.pause(); } catch {}
      }
    });
  }

  // ====== BOOTSTRAP (auto-restore license on load) ======
  (async function bootstrapLicense(){
    const saved = loadLicense();
    if (!saved?.key) { applyFullMode(false); return; }
    try {
      const res = await verifyKey(saved.key);
      if (res.valid) {
        applyFullMode(true);
      } else {
        clearLicense();
        applyFullMode(false);
      }
    } catch {
      // If server is unreachable, keep last known state (best effort)
      applyFullMode(!!saved?.key);
    }
  })();

  // ====== ACTIVATE / DEACTIVATE BUTTONS ======
  activateBtn?.addEventListener('click', async ()=>{
    const key = (input?.value || '').trim();
    if (!key) { alert('Please enter your license key.'); return; }

    activateBtn.disabled = true;
    const oldText = activateBtn.textContent;
    activateBtn.textContent = 'Checking‚Ä¶';

    try {
      const vr = await verifyKey(key);
      if (!vr.valid) {
        alert('Key not valid: ' + (vr.reason || 'unknown'));
        applyFullMode(false);
        return;
      }

      const deviceId = getDeviceId();
      const act = await activateKey(key, deviceId);
      if (act.ok === false) {
        alert('Activation error: ' + (act.reason || 'unknown'));
        applyFullMode(false);
        return;
      }

      saveLicense(key, vr.plan || 'full');
      applyFullMode(true);
      alert('License activated. Full features unlocked.');
    } catch (e) {
      console.error(e);
      alert('Network error while activating. Please try again.');
    } finally {
      activateBtn.disabled = false;
      activateBtn.textContent = oldText;
    }
  });

  deactivateBtn?.addEventListener('click', async ()=>{
    const saved = loadLicense();
    // Best-effort server notify
    try {
      if (saved?.key) {
        const deviceId = getDeviceId();
        await deactivateKey(saved.key, deviceId);
      }
    } catch {}
    clearLicense();
    applyFullMode(false);
    alert('License removed. You are back in demo mode.');
  });

  // ====== OPTIONAL: PREVENT AUTO-PLAY ON FILE LOAD (if your original did auto-play) ======
  // If your original on file-change does "media.play()", comment it there.
  // This guard stops "Play All" from starting locked strips even if a file was just loaded.
  document.addEventListener('change', (e)=>{
    const input = e.target;
    if (input && input.matches('input[type="file"]')){
      // Find which strip this file input belongs to and prevent auto-start if locked
      const strip = input.closest('.strip');
      if (!strip) return;
      const allStrips = Array.from(document.querySelectorAll('.strip'));
      const idx = allStrips.indexOf(strip);
      if (isStripLocked(idx)) {
        // If your code starts playback immediately after load, this ensures it gets paused.
        // (We do not interfere with your file URL assignment.)
        const chId = Object.keys(state.channels)[idx];
        const ch   = state.channels[chId];
        if (ch?.media) { try { ch.media.pause(); } catch {} }
      }
    }
  }, true);
})();
</script>
</body>
</html>
